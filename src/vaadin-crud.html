<!--
@license
Copyright (c) 2017 Vaadin Ltd.
This program is available under Commercial Vaadin Add-On License 3.0, available at http://vaadin.com/license/cval-3.
-->

<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../vaadin-themable-mixin/vaadin-themable-mixin.html">
<link rel="import" href="../../vaadin-element-mixin/vaadin-element-mixin.html">
<link rel="import" href="../../vaadin-button/src/vaadin-button.html">
<link rel="import" href="../../vaadin-dialog/src/vaadin-dialog.html">
<link rel="import" href="../../vaadin-confirm-dialog/src/vaadin-confirm-dialog.html">
<link rel="import" href="../../vaadin-license-checker/vaadin-license-checker.html">
<link rel="import" href="vaadin-dialog-layout.html">
<link rel="import" href="vaadin-crud-grid.html">
<link rel="import" href="vaadin-crud-form.html">

<dom-module id="vaadin-crud">
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: column;
        height: 400px;
        flex: 1 1 100%;
        align-self: stretch;
        position: relative;
      }

      :host([hidden]) {
        display: none !important;
      }

      [part=toolbar] {
        display: flex;
        flex-shrink: 0;
        align-items: baseline;
      }

      [part=footer] {
        flex: auto;
      }
    </style>

    <slot name="grid">
      <vaadin-crud-grid id="grid" exclude="[[exclude]]" no-sort="[[noSort]]" no-filter="[[noFilter]]" no-head="[[noHead]]"></vaadin-crud-grid>
    </slot>

    <div part="toolbar" on-click="__new">
      <div part="footer"><slot name="footer"></slot></div>
      <slot name="new">
        <vaadin-button id="new">[[i18n.new]] [[entityName]]</vaadin-button>
      </slot>
    </div>

    <vaadin-dialog-layout id="dialog" no-close-on-outside-click=[[__isDirty]] no-close-on-esc=[[__isDirty]] opened="{{opened}}" theme="crud">
      <h3 slot="header">[[__editorHeader]]</h3>
      <div id="editor">
        <slot name="form">
          <vaadin-crud-form id="form" exclude="[[exclude]]"></vaadin-crud-form>
        </slot>
      </div>

      <vaadin-button slot="footer" on-click="__save" theme="raised primary" disabled="[[!__isDirty]]">[[i18n.save]]</vaadin-button>
      <vaadin-button slot="footer" on-click="__cancel" theme="raised" style="margin-left: 1em">[[i18n.cancel]]</vaadin-button>
      <div slot="footer" style="flex: auto"></div>
      <vaadin-button slot="footer" on-click="__delete" theme="raised tertiary error" hidden="[[__isNew]]">[[i18n.delete]]</vaadin-button>
    </vaadin-dialog-layout>

    <vaadin-confirm-dialog id="confirmCancel" on-reject="__confirmCancel" reject
      reject-text="[[i18n.confirm.cancel.button.continue]]"
      confirm-text="[[i18n.confirm.cancel.button.cancel]]"
      header="[[i18n.confirm.cancel.header]]">
      [[i18n.confirm.cancel.prefix]] [[entityName]] [[i18n.confirm.cancel.suffix]].
    </vaadin-confirm-dialog>
    <vaadin-confirm-dialog id="confirmDelete" on-confirm="__confirmDelete"
      cancel confirm-text="[[i18n.confirm.delete.button.continue]]"
      reject-text="[[i18n.confirm.delete.button.cancel]]"
      header="[[i18n.confirm.delete.header]]" confirm-theme="error">
      [[i18n.confirm.delete.prefix]] [[entityName]] [[i18n.confirm.delete.suffix]].
    </vaadin-confirm-dialog>
  </template>

  <script>
    (function() {
      /**
       * `<vaadin-crud>` is a Web Component for [CRUD](https://en.wikipedia.org/wiki/Create,_read,_update_and_delete) operations.
       *
       * ### Quick Start
       *
       * Assign an array to the [`items`](#/elements/vaadin-crud#property-items) property.
       *
       * A grid and an editor will be automatically generated and configured based on the data structure provided.
       *
       * #### Example:
       * ```html
       * <vaadin-crud items='[{"name": "John", "surname": "Lennon", "role": "singer"},
       *                      {"name": "Ringo", "surname": "Starr", "role": "drums"}]'>
       * </vaadin-crud>
       * ```
       *
       * ### Data Provider Function
       *
       * Otherwise, you can provide a [`dataProvider`](#/elements/vaadin-crud#property-dataProvider) function.
       * #### Example:
       * ```html
       * <vaadin-crud></vaadin-crud>
       * ```
       * ```js
       * const crud = document.querySelector('vaadin-crud');
       * const users = [{'name': 'John', 'surname': 'Lennon', 'role': 'singer'}, ...];
       * crud.dataProvider = function(params, callback) {
       *   const chunk = users.slice(params.page * params.pageSize, params.page * params.pageSize + params.pageSize);
       *   callback(chunk, people.length);
       * };
       * ```
       *
       * ### Customization
       *
       * Alternatively you can fully configure the component by providing your own Grid and Editor and Footer content.
       *
       * NOTE: that you need to provide a `vaadin-crud-grid-edit-column`.
       *
       * #### Example:
       * ```html
       * <vaadin-crud items='[{"name": "John", "surname": "Lennon", "role": "singer"},
       *                      {"name": "Ringo", "surname": "Starr", "role": "drums"}]'>
       *  <vaadin-grid slot="grid">
       *   <vaadin-crud-grid-edit-column></vaadin-crud-grid-edit-column>
       *   <vaadin-grid-column>
       *    <template class="header">Name</template><template>[[item.name]]</template>
       *   </vaadin-grid-column>
       *   <vaadin-grid-column>
       *    <template class="header">Surname</template><template>[[item.surname]]</template>
       *   </vaadin-grid-column>
       *  </vaadin-grid>
       *  <vaadin-form-layout slot="form">
       *   <vaadin-text-field label="First" path="name"></vaadin-text-field>
       *   <vaadin-text-field label="Surname" path="surname"></vaadin-text-field>
       *  </vaadin-form-layout>
       *  <div slot="footer">Total Users: [[size]]</div>
       * </vaadin-crud>
       * ```
       * ```js
       * const crud = document.querySelector('vaadin-crud');
       * const users = [{'name': 'John', 'surname': 'Lennon', 'role': 'singer'}, ...];
       * crud.dataProvider = function(params, callback) {
       *   const chunk = users.slice(params.page * params.pageSize, params.page * params.pageSize + params.pageSize);
       *   callback(chunk, people.length);
       * };
       * ```
       *
       * The following helper elements are used to autofonfigure CRUD grid and editor
       * - [`<vaadin-crud-grid>`](#/elements/vaadin-crud-grid)
       * - [`<vaadin-crud-form>`](#/elements/vaadin-crud-form)
       *
       * ### Styling
       *
       * The following shadow DOM parts are available for styling:
       *
       * Part name | Description
       * ----------------|----------------
       * `toolbar` | Toolbar container.
       * `footer` | The footer container in the toolbar.
       *
       * See [ThemableMixin â€“ how to apply styles for shadow parts](https://github.com/vaadin/vaadin-themable-mixin/wiki)
       *
       * @memberof Vaadin
       * @mixes Vaadin.ElementMixin
       * @mixes Vaadin.ThemableMixin
       * @demo demo/index.html
       */
      class CrudElement extends Vaadin.ElementMixin(Vaadin.ThemableMixin(Polymer.Element)) {
        static get is() {
          return 'vaadin-crud';
        }

        static get version() {
          return '1.0.0-alpha2';
        }

        static get properties() {
          return {
            /** A reference to the grid used for displaying the item list */
            _grid: {
              type: HTMLElement,
              observer: '__onGridChange'
            },
            /** A reference to the editor component which will be teleported to the dialog */
            _form: {
              type: HTMLElement,
              observer: '__onFormChange'
            },
            /**
             * An array containing the items which will be stamped to the column template instances.
             */
            items: {
              type: Array,
              observer: '__onItemsChange'
            },
            /**
             * The item being edited in the dialog.
             */
            item: {
              type: Object,
              observer: '__onItemChange'
            },
            /**
             * Function that provides items lazily. Receives arguments `params`, `callback`
             *
             * `params.page` Requested page index
             * `params.pageSize` Current page size
             * `params.filters` Currently applied filters
             * `params.sortOrders` Currently applied sorting orders
             *
             * `callback(items, size)` Callback function with arguments:
             *   - `items` Current page of items
             *   - `size` Total number of items
             */
            dataProvider: {
              type: Function,
              observer: '__onDataProviderChange'
            },
            /**
             * Disable filtering when grid is autofonfigured.
             */
            noFilter: Boolean,
            /**
             * Disable sorting when grid is autofonfigured.
             */
            noSort: Boolean,
            /**
             * Remove grid headers when it is autoconfigured.
             */
            noHead: Boolean,
            /**
             * A regular expression string to applied to fields that will be exclude
             * when using autoconfigured elements.
             *
             * Default is `/^_` meaning that all protected properties are excluded
             */
            exclude: {
              type: String,
              value: '^_'
            },
            /**
             * Reflects the opened status of the editor.
             */
            opened: {
              type: Boolean,
              notify: true,
              observer: '__onOpenedChanged'
            },
            /**
             * The description of the entity associated with this CRUD.
             */
            entityName: {
              type: String,
              value: 'item'
            },
            /**
             * Number of items in the data set which is reported by the grid.
             */
            size: {
              type: Number,
              readOnly: true,
              notify: true
            },
            /**
             * The object used to localize this component.
             * For changing the default localization, change the entire
             * _i18n_ object or just the property you want to modify.
             *
             * The object has the following JSON structure and default values:
              {
                new: 'New',
                edit: 'Edit',
                save: 'Save',
                cancel: 'Cancel',
                delete: 'Delete...',
                confirm: {
                  delete: {
                    header: 'Confirm delete',
                    prefix: 'Are you sure you want to delete the selected',
                    suffix: '? This action cannot be undone.',
                    button: {
                      continue: 'Delete',
                      cancel: 'Cancel'
                    }
                  },
                  cancel: {
                    header: 'Unsaved changes',
                    title: 'Continue editing',
                    prefix: 'There are unsaved modifications to the',
                    suffix: '',
                    button: {
                      continue: 'Discard changes',
                      cancel: 'Continue editing'
                    }
                  }
                }
              }
             */
            i18n: {
              type: Object,
              value: function() {
                return {
                  new: 'New',
                  edit: 'Edit',
                  save: 'Save',
                  cancel: 'Cancel',
                  delete: 'Delete...',
                  confirm: {
                    delete: {
                      header: 'Confirm delete',
                      prefix: 'Are you sure you want to delete the selected',
                      suffix: '? This action cannot be undone.',
                      button: {
                        continue: 'Delete',
                        cancel: 'Cancel'
                      }
                    },
                    cancel: {
                      header: 'Unsaved changes',
                      title: 'Continue editing',
                      prefix: 'There are unsaved modifications to the',
                      suffix: '',
                      button: {
                        continue: 'Discard changes',
                        cancel: 'Continue editing'
                      }
                    },
                  }
                };
              }
            },
            __isDirty: Boolean,
            __isNew: Boolean,
            __editorHeader: String
          };
        }

        constructor() {
          super();
          this._observer = new Polymer.FlattenedNodesObserver(this, info => {
            this.__onDomChange(info.addedNodes);
          });
        }

        ready() {
          super.ready();
          this.__editListener = e => this.__onCrudGridEdit(e);
          this.__changeListener = e => this.__onFormChanges(e);
          this.__gridSizeListener = this.__onGridSizeChanges.bind(this);
          this._grid = this.$.grid;
          this._form = this.$.form;
        }

        __onOpenedChanged(opened, old) {
          if (!opened && old) {
            this.__closeEditor();
          } else {
            this.__editorHeader = (this.__isNew ? this.i18n.new : this.i18n.edit) + ' ' + this.entityName;
            this.__onFormChange(this._form);
          }
        }

        __onDomChange(nodes) {
          nodes.forEach(node => {
            if (node instanceof Vaadin.GridElement) {
              this._grid = node;
            }
            if (node.getAttribute && node.getAttribute('slot') === 'form') {
              this._form = node;
            }
          });
        }

        __onCrudGridEdit(e) {
          e.stopPropagation();
          this.__edit(e.detail.item);
        }

        __onFormChanges(e) {
          this.__isDirty = true;
        }

        __onGridSizeChanges(e) {
          this._setSize(this._grid.size);
        }

        __onGridChange(grid, old) {
          if (old) {
            old.removeEventListener('edit', this.__editListener);
            old.removeEventListener('size-changed', this.__gridSizeListener);
          }
          if (grid != this.$.grid) {
            grid.setAttribute('slot', 'grid');
          }
          if (this.items) {
            this.__onItemsChange(this.items);
          }
          if (this.item) {
            this.__onItemChange(this.item);
          }
          grid.addEventListener('edit', this.__editListener);
          grid.addEventListener('size-changed', this.__gridSizeListener);
          this.__onGridSizeChanges();
        }

        __onFormChange(form, old) {
          if (old && old.parentElement) {
            old.parentElement && old.parentElement.removeChild(old);
            old.removeEventListener('change', this.__changeListener);
          }
          if (!form) {
            return;
          }
          if (this.items) {
            this.__onItemsChange(this.items);
          }
          if (this.item) {
            this.__onItemChange(this.item);
          }
          if (this.$.form != form) {
            // move slotted from this to the overlay DOM so as it can target the slot
            this.$.dialog.$.dialog.$.overlay.appendChild(form);
          }
          form.addEventListener('change', this.__changeListener);
        }

        __onDataProviderChange(dataProvider) {
          if (this._grid) {
            this._grid.dataProvider = dataProvider;
          }
        }

        __onItemsChange(items) {
          if (this._grid) {
            this._grid.items = items;
          }
        }

        __onItemChange(item, old) {
          if (!this._form) {
            return;
          }
          if (item) {
            if (!this._fields.length && this._form.configure) {
              this._form.configure(this._grid._cache.items[0]);
            }
            this._form.item = item;
            this._fields.forEach(e => {
              const path = e.path || e.getAttribute('path');
              path && (e.value = this.get(path, item));
            });
          }

          this.__isNew = this.__isNew || this.items && this.items.indexOf(item) < 0;
          this.opened = !!item;
        }

        /** A reference to all fields inside the [`_form`](#/elements/vaadin-crud#property-_form) element */
        get _fields() {
          if (!this.__fields || !this.__fields.length) {
            this.__fields = Array.from(this._form.querySelectorAll('*')).filter(e => e.validate || e.checkValidity);
          }
          return this.__fields;
        }

        __validate() {
          return this._fields.every(e => (e.validate || e.checkValidity).call(e));
        }

        __closeEditor() {
          this.opened = false;
          // Delay changing the item in order not to modify editor while closing
          setTimeout(() => this.item = undefined);
        }

        __new(event) {
          // This allows listening to parent element and fire only when clicking on default or custom new-button.
          if (event.composedPath().filter(e => e.nodeType == 1 && (e.getAttribute('slot') || e.id) == 'new')[0]) {
            this.__openEditor('new');
          }
        }

        __edit(item) {
          this.__openEditor('edit', item);
        }

        __openEditor(type, item) {
          this.__isDirty = false;
          this.__isNew = !item;
          const evt = this.dispatchEvent(new CustomEvent(this.__isNew ? 'new' : 'edit', {detail: {item: item}, cancelable: true}));
          if (evt) {
            this.item = item || {};
          } else {
            this.opened = true;
          }
        }

        __save() {
          if (!this.__validate()) {
            return;
          }

          const item = this.item || {};
          this._fields.forEach(e => {
            const path = e.path || e.getAttribute('path');
            path && this.__set(path, e.value, this.item);
          });
          const evt = this.dispatchEvent(new CustomEvent('save', {detail: {item: item}, cancelable: true}));
          if (evt) {
            if (this.__isNew && this.items) {
              this.items.push(item);
            }
            this._grid.clearCache();
            this.__closeEditor();
          }
        }

        __focusConfirmButton(confirmDlg, id) {
          // Remove when https://github.com/vaadin/vaadin-confirm-dialog/issues/57 is done
          confirmDlg.$.dialog.$.overlay.content.querySelector(`vaadin-button#${id}`).focus();
        }

        __cancel() {
          if (this.__isDirty) {
            this.$.confirmCancel.opened = true;
            this.__focusConfirmButton(this.$.confirmCancel, 'confirm');
          } else {
            this.__confirmCancel();
          }
        }

        __confirmCancel() {
          const evt = this.dispatchEvent(new CustomEvent('cancel', {detail: {item: this.item}, cancelable: true}));
          if (evt) {
            this.__closeEditor();
          }
        }

        __delete() {
          this.$.confirmDelete.opened = true;
          this.__focusConfirmButton(this.$.confirmDelete, 'confirm');
        }

        __confirmDelete() {
          const evt = this.dispatchEvent(new CustomEvent('delete', {detail: {item: this.item}, cancelable: true}));
          if (evt) {
            if (this.items && this.items.indexOf(this.item) >= 0) {
              this.items.splice(this.items.indexOf(this.item), 1);
            }
            this._grid.clearCache();
            this.__closeEditor();
          }
        }

        // Utility method for setting nested values in JSON objects but initialising empty keys unless `Polymer.Base.set`
        __set(path, val, obj) {
          if (obj && path) {
            path.split('.').slice(0, -1).reduce((o, p) => (o[p] = o[p] || {}), obj);
            this.set(path, val, obj);
          }
        }

        /**
         * Fired when user wants to edit an existing item. If the default is prevented, then
         * a new item is not assigned to the form, giving that responsability to the app, though
         * dialog is always opened.
         *
         * @event edit
         * @param {Object} detail.item the item to edit
         */
        /**
         * Fired when user wants to create a new item.
         *
         * @event new
         */
        /**
         * Fired when user wants to delete item. If the default is prevented, then
         * no action is performed, items array is not modified nor dialog closed
         *
         * @event delete
         * @param {Object} detail.item the item to delete
         */
        /**
         * Fired when user discards edition. If the default is prevented, then
         * no action is performed, user is responsible to close dialog and reset
         * item and grid.
         *
         * @event cancel
         * @param {Object} detail.item the item to delete
         */
        /**
         * Fired when user wants to save a new or an existing item. If the default is prevented, then
         * no action is performed, items array is not modified nor dialog closed
         *
         * @event save
         * @param {Object} detail.item the item to save
         * @param {Object} detail.new whether the item is a new one
         */
      }

      customElements.define(CrudElement.is, CrudElement);

      /**
       * @namespace Vaadin
       */
      window.Vaadin.CrudElement = CrudElement;

      const licenseChecker = window.Vaadin.developmentModeCallback
        && window.Vaadin.developmentModeCallback['vaadin-license-checker'];
      if (typeof licenseChecker === 'function') {
        licenseChecker(CrudElement);
      }
    })();
  </script>
</dom-module>
