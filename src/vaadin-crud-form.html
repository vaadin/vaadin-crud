<!--
@license
Copyright (c) 2018 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../vaadin-form-layout/vaadin-form-item.html">
<link rel="import" href="../../vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../../vaadin-text-field/vaadin-password-field.html">

  <script>
    (function() {

      /**
       * @memberof Vaadin
       */
      class VaadinCrudForm extends Vaadin.FormLayoutElement {
        static get is() {
          return 'vaadin-crud-form';
        }

        static get version() {
          return '0.1.0';
        }

        static get properties() {
          return {
            excluded: {
              type: RegExp,
              value: /^_/i
            },
            item: Object
          };
        }

        static get observers() {
          return ['__onItemChange(item)'];
        }

        _byString(o, s) {
          s = s.replace(/\[["']?(\w+)["']?\]/g, '.$1'); // convert indexes to properties
          s = s.replace(/^\./, '');           // strip a leading dot
          var a = s.split('.');
          for (var i = 0, n = a.length; i < n; ++i) {
            var k = a[i];
            if (k in o) {
              o = o[k];
            } else {
              return;
            }
          }
          return o;
        }

        configure(object) {
          this.innerHTML = '';
          this.__fields = [];
          this.__createFields(this, object);
          this.notifyResize();
        }

        __onItemChange(item) {
          if (!this.__fields) {
            this.configure(item);
          }
          this.__fields.forEach(field => {
            field.value = this._byString(item, field.path);
          });
        }

        __camelize(path) {
          return path.replace(/(^|[ -_])([a-z])/g, ($0, $1, $2) => ' ' + $2.toUpperCase());
        }

        __createField(parent, path, type) {
          let field = document.createElement('vaadin-text-field');
          field.label = this.__camelize((path || '').replace(/^.*\./, ''));
          field.path = path;
          parent.appendChild(field);
          this.__fields.push(field);
          return field;
        }

        __createFields(parent, object, path) {
          if (typeof object === 'object') {
            Object.keys(object).forEach(prop => {
              if (this.excluded && this.excluded.test(prop)) {
                return;
              }
              const newPath = (path ? `${path}.` : '') + prop;
              if (typeof object[prop] === 'object') {
                this.__createFields(parent, object[prop], newPath);
              } else {
                this.__createField(parent, newPath);
              }
            });
          } else {
            this.__createField(parent, '');
          }
        }
      }

      customElements.define(VaadinCrudForm.is, VaadinCrudForm);

      /**
       * @namespace Vaadin
       */
      window.Vaadin.CrudFormElement = VaadinCrudForm;
    })();
  </script>
